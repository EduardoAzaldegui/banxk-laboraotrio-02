pipeline {
    agent any

    environment {
        // Variables espec√≠ficas del proyecto
        PROJECT_PATH = 'bank-infrastructure'
        COMPOSE_FILE = 'docker-compose.yml'
        PROJECT_NAME = 'bank-infra'
        
        // Mapeo de variables de entorno (asumiendo que vienen de Jenkins Global Vars o .env)
        // Si no vienen inyectadas, puedes poner los valores "hardcodeados" aqu√≠ como fallback
        GITHUB_REPO_URL_INFRA = "${env.GITHUB_REPO_URL_INFRA ?: 'https://github.com/EduardoAzaldegui/banxk-laboraotrio-02.git'}"
        GITHUB_BRANCH_INFRA = "${env.GITHUB_BRANCH_INFRA ?: 'main'}"
    }

    stages {
        // 1. Diagn√≥stico del Entorno
        stage('üîç Verificar Entorno Docker') {
            steps {
                script {
                    sh '''
                    echo "=== DIAGN√ìSTICO DE INFRAESTRUCTURA ==="
                    echo "üê≥ Docker Version:"
                    docker --version
                    echo "üêô Docker Compose Version:"
                    docker compose version
                    echo "üìÇ Directorio de trabajo: $(pwd)"
                    echo "======================================"
                    '''
                }
            }
        }

        // 2. Preparaci√≥n
        stage('üßπ Preparaci√≥n') {
            steps {
                echo "üöÄ Iniciando despliegue Infraestructura: ${GITHUB_REPO_URL_INFRA}"
                echo "üåø Rama: ${GITHUB_BRANCH_INFRA}"
                cleanWs()
            }
        }

        // 3. Clonar Repositorio (TU VERSI√ìN MANUAL)
        stage('üì• Clonar Repositorio') {
            steps {
                script {
                    echo "üì¶ Clonando repositorio..."
                    git branch: GITHUB_BRANCH_INFRA,
                        credentialsId: 'github-token', // Aseg√∫rate que este ID coincida con tu jenkins.yaml
                        url: GITHUB_REPO_URL_INFRA
                    
                    // Mostramos el √∫ltimo commit para tener trazabilidad en los logs
                    sh 'git log -1 --oneline'
                }
            }
        }

        // 4. Chequeos previos
        stage('üîß Pre-Deploy Checks') {
            steps {
                dir(PROJECT_PATH) {
                    script {
                        echo "üõ†Ô∏è Verificando archivos de configuraci√≥n..."
                        sh '''
                        if [ -f "docker-compose.yml" ]; then
                            echo "‚úÖ docker-compose.yml encontrado."
                        else
                            echo "‚ùå ERROR: No se encontr√≥ docker-compose.yml en ${PROJECT_PATH}"
                            ls -la
                            exit 1
                        fi
                        '''
                    }
                }
            }
        }

        // 5. Limpieza Profunda
        stage('üßπ Limpieza Docker Profunda') {
            steps {
                dir(PROJECT_PATH) {
                    script {
                        echo "üßπ EJECUTANDO LIMPIEZA DE CONTENEDORES E IM√ÅGENES..."
                        sh """
                        # Bajamos servicios y borramos vol√∫menes para inicio limpio
                        echo "üõë Deteniendo stack '${PROJECT_NAME}'..."
                        docker compose -p ${PROJECT_NAME} down -v --remove-orphans || true

                        # Limpieza general de mantenimiento
                        docker container prune -f
                        
                        echo "=== ESTADO DOCKER TRAS LIMPIEZA ==="
                        docker ps -a | grep ${PROJECT_NAME} || echo "‚úÖ Todo limpio."
                        """
                    }
                }
            }
        }

        // 6. Despliegue
        stage('üöÄ Desplegar Infraestructura') {
            steps {
                dir(PROJECT_PATH) {
                    script {
                        echo "üèóÔ∏è Levantando servicios con Docker Compose..."
                        // --build asegura que si cambiaron las im√°genes base, se actualicen
                        sh "docker compose -p ${PROJECT_NAME} up -d --build"
                        
                        echo "üìú Logs iniciales:"
                        sh "docker compose -p ${PROJECT_NAME} logs --tail=10"
                    }
                }
            }
        }

        // 7. Health Check
        stage('üè• Health Check') {
            steps {
                script {
                    echo "‚è≥ Iniciando verificaci√≥n de salud..."
                    sleep 30 // Tiempo de gracia para Kafka/Sonar
                    
                    dir(PROJECT_PATH) {
                        sh '''
                        MAX_RETRIES=12
                        attempt=1
                        healthy=false
                        
                        echo "üîç Verificando estado de contenedores cr√≠ticos..."
                        
                        while [ $attempt -le $MAX_RETRIES ]; do
                            # Verificamos si Kafka y Mongo est√°n corriendo
                            KAFKA_STATE=$(docker inspect -f '{{.State.Status}}' kafka 2>/dev/null || echo "not_found")
                            MONGO_STATE=$(docker inspect -f '{{.State.Status}}' mongo-bank 2>/dev/null || echo "not_found")
                            
                            echo "‚è±Ô∏è Intento $attempt/$MAX_RETRIES - Kafka: $KAFKA_STATE | Mongo: $MONGO_STATE"
                            
                            if [ "$KAFKA_STATE" = "running" ] && [ "$MONGO_STATE" = "running" ]; then
                                echo "‚úÖ Contenedores principales RUNNING."
                                healthy=true
                                break
                            fi
                            
                            echo "üí§ Esperando 10 segundos..."
                            sleep 10
                            attempt=$((attempt + 1))
                        done
                        
                        if [ "$healthy" != "true" ]; then
                            echo "‚ùå TIMEOUT: Servicios no iniciaron correctamente."
                            docker compose -p ${PROJECT_NAME} logs --tail=50
                            exit 1
                        fi
                        
                        echo "üéâ Infraestructura operativa."
                        '''
                    }
                }
            }
        }
        
        // 8. Visualizar Logs Finales
        stage('üìã Logs Finales') {
             steps {
                 dir(PROJECT_PATH) {
                     script {
                         echo "üìù Estado final de los contenedores:"
                         sh "docker compose -p ${PROJECT_NAME} ps"
                     }
                 }
             }
        }
    }

    post {
        always {
            cleanWs()
        }
        
        success {
            script {
                echo """
                ‚úÖ DEPLOY INFRAESTRUCTURA EXITOSO ‚úÖ
                ======================= RESUMEN =======================
                üéØ Proyecto:        ${PROJECT_NAME}
                üåø Rama:            ${GITHUB_BRANCH_INFRA}
                ‚è±Ô∏è Tiempo:          ${currentBuild.durationString}
                ======================================================
                """
            }
        }

        failure {
            script {
                echo """
                ‚ùå FALLA EN DEPLOY INFRAESTRUCTURA ‚ùå
                ====================== DIAGN√ìSTICO ===================
                Build:     #${BUILD_NUMBER}
                Error:     ${currentBuild.result}
                ======================================================
                """
                dir(PROJECT_PATH) {
                    sh "docker compose -p ${PROJECT_NAME} logs --tail=50 || true"
                }
            }
        }
    }
}