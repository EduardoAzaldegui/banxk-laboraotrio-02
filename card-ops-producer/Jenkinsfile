pipeline {
  agent any

  environment {
    // Variables de Jenkins (vienen del .env)
    GITHUB_REPO_URL_PRODUCER = "${GITHUB_REPO_URL_PRODUCER}"
    GITHUB_BRANCH_PRODUCER = "${GITHUB_BRANCH_PRODUCER}"
    APP_ENVIRONMENT = "${APP_ENVIRONMENT}"
    APP_PORT = "8085"
    JAVA_VERSION = "${JAVA_VERSION}"
    AWS_DEFAULT_REGION = "${AWS_DEFAULT_REGION}"
    COMPOSE_FILE = "${APP_COMPOSE_FILE}"
  }

  stages {

    stage('üîç Verificar Entorno Java') {
        steps {
            script {
            sh '''
            echo "=== DIAGN√ìSTICO DE JAVA ==="
            java -version
            javac -version
            mvn -version
            echo "JAVA_HOME: $JAVA_HOME"
            echo "==========================="
            '''
            }
        }
    }

    stage('üîç Preparaci√≥n') {
      steps {
        echo "üöÄ Iniciando despliegue Java Spring Boot: ${GITHUB_REPO_URL_PRODUCER}"
        echo "üåø Rama: ${GITHUB_BRANCH_PRODUCER}"
        echo "‚òï Versi√≥n Java: ${JAVA_VERSION}"
        echo "üì° Puerto: 8085"
        cleanWs()
      }
    }

    stage('üì• Clonar Repositorio') {
      steps {
        script {
          echo "üì¶ Clonando repositorio...2"
          git branch: GITHUB_BRANCH_PRODUCER,
              credentialsId: 'github-token',
              url: GITHUB_REPO_URL_PRODUCER
          sh 'git log -1 --oneline'
        }
      }
    }

    stage('üîß Pre-Deploy') {
      steps {
        script {
          echo "üõ†Ô∏è Preparando despliegue..."
          sh '''
            echo "üìã Verificando la estructura del proyecto..."
            ls -la

            if [ -f "pom.xml" ] || [ -f "build.gradle" ]; then
              echo "‚úÖ Archivo de construcci√≥n encontrado"
            else
              echo "‚ùå Ni pom.xml ni build.gradle encontrados"
              exit 1
            fi

            if [ -f "Dockerfile" ]; then
              echo "‚úÖ Dockerfile encontrado"
            else
              echo "‚ùå Dockerfile no encontrado"
              exit 1
            fi

            if [ -f "docker-compose.yml" ]; then
              echo "‚úÖ docker-compose.yml encontrado"
            else
              echo "‚ùå docker-compose.yml no encontrado"
              exit 1
            fi

            if [ -f "Jenkinsfile" ]; then
              echo "‚úÖ Jenkinsfile encontrado"
            else
              echo "‚ùå Jenkinsfile no encontrado"
              exit 1
            fi

            # Verificar puerto
            echo "üîç Verificando puerto 8085..."
            if netstat -tuln | grep -q ":8085"; then
              echo "‚ö†Ô∏è Puerto 8085 ya en uso"
            else
              echo "‚úÖ Puerto 8085 disponible"
            fi
          '''

          sh '''
            echo "üõë Deteniendo servicios existentes..."
            docker compose down || echo "No services running"
          '''
        }
      }
    }

    stage('üßπ Limpieza Docker') {
      steps {
        script {
          echo "üßπ LIMPIANDO IM√ÅGENES Y CONTENEDORES ANTERIORES..."

          sh '''
            # Parar y eliminar contenedores del proyecto
            docker compose down --remove-orphans --rmi all || true

            # Eliminar contenedores hu√©rfanos
            docker container prune -f

            # Eliminar im√°genes sin usar
            docker image prune -a -f

            # Eliminar espec√≠ficamente im√°genes de java-app
            docker images | grep "java-app" | awk '{print $3}' | xargs docker rmi -f || true

            # Eliminar im√°genes dangling
            docker rmi $(docker images -f "dangling=true" -q) 2>/dev/null || true
          '''
        }
      }
    }

    stage('üèóÔ∏è Construir Aplicaci√≥n Java') {
      steps {
        script {
          echo "üì¶ Construyendo JAR con Maven/Gradle..."
          sh '''
            # Detectar si es Maven o Gradle
            if [ -f "pom.xml" ]; then
              echo "üî® Usando Maven..."
              # Verificar versi√≥n de Java y Maven
              echo "Versi√≥n de Java:"
              java -version
              echo "Versi√≥n de Maven:"
              mvn -version
              # ¬°¬°¬°DAR PERMISOS DE EJECUCI√ìN AL MAVEN WRAPPER!!!
              chmod +x ./mvnw
              mvn clean package -DskipTests --batch-mode
              # Verificar que el JAR se gener√≥
              ls -la target/*.jar
            elif [ -f "build.gradle" ]; then
              echo "üî® Usando Gradle..."
              # ¬°¬°¬°DAR PERMISOS DE EJECUCI√ìN AL GRADLE WRAPPER!!!
              chmod +x ./gradlew
              ./gradlew build -x test
              # Verificar que el JAR se gener√≥
              ls -la build/libs/*.jar
            else
              echo "‚ùå No se encontr√≥ ni pom.xml ni build.gradle"
              exit 1
            fi
          '''
        }
      }
    }

    stage('üîç Verificar Archivos') {
      steps {
        sh 'pwd'
        sh 'ls -la'
      }
    }


    stage('üöÄ Desplegar App Java') {
      steps {
        script {
          echo "üßπ Eliminando cualquier contenedor previo llamado 'java-app'..."
          sh '''
            docker rm -f java-app 2>/dev/null || true
          '''

          echo "üì¶ Construyendo y desplegando imagen Docker..."
          sh '''
            echo "üì¶ IP para PEKKO_HOST: ${PEKKO_HOST}"
            export PEKKO_HOST=${PEKKO_HOST}

            # Construir sin cach√©
            docker compose build --no-cache --pull --build-arg JAVA_VERSION=${JAVA_VERSION}

            # MODIFICADO: Solo levantamos java-app
            docker compose up -d java-app

            echo "‚úÖ Aplicaci√≥n Java Spring Boot desplegada en puerto 8085"
          '''
        }
      }
    }

    stage('üè• Health Check') {
      steps {
        script {
          echo "üîç Verificando estado de la App Java v√≠a Actuator..."
          sh '''
            echo "‚è≥ Esperando que el endpoint /actuator/health responda OK..."

            MAX_RETRIES=18
            attempt=1
            healthy=false

            CONTAINER_ID=$(docker compose ps -q java-app)
            if [ -z "$CONTAINER_ID" ]; then
              echo "‚ùå No se encontr√≥ el contenedor para el servicio 'java-app'"
              docker compose ps
              exit 1
            fi
            echo "üê≥ ID del contenedor: $CONTAINER_ID"

            while [ $attempt -le $MAX_RETRIES ]; do
              docker_status=$(docker inspect -f '{{.State.Health.Status}}' $CONTAINER_ID 2>/dev/null || echo "unknown")
              echo "üê≥ Estado Docker: $docker_status"

              if [ "$docker_status" = "healthy" ]; then
                echo "‚úÖ App Java est√° saludable seg√∫n Docker"
                healthy=true
                break
              fi

              if [ "$docker_status" = "unhealthy" ]; then
                  echo "‚ùå App Java est√° en estado UNHEALTHY seg√∫n Docker"
                  docker exec java-app curl -v http://localhost:8085/actuator/health || echo "Curl fall√≥"
                  docker compose logs --tail=50 java-app
                  exit 1
              fi

              echo "‚åõ Intento $attempt/$MAX_RETRIES - Esperando..."
              sleep 10
              attempt=$((attempt + 1))
            done

            if [ "$healthy" != "true" ]; then
              echo "‚ùå Timeout: La app no alcanz√≥ estado HEALTHY"
              curl -v http://localhost:8085/actuator/health || echo "Curl fall√≥"
              docker compose logs --tail=100 java-app
              exit 1
            fi

            echo "üéâ ¬°Health Check completado con √©xito!"
          '''
        }
      }
    }

    // ELIMINADO: stage('üìù Registro Manual en Consul')

    stage('üìã Ver Logs en Servidor') {
      steps {
        script {
          echo "üìù Copiando logs desde el contenedor al workspace..."
          sh '''
            # Copia los logs desde el contenedor
            docker cp java-app:/app/logs/. /shared-logs/pluggyLogs/build/ 2>/dev/null || echo "‚ÑπÔ∏è  No hay logs a√∫n"

            if [ -d "/shared-logs" ]; then
              echo "üìÇ Contenido de /shared-logs: ..."
              ls -la /shared-logs/
            else
              echo "‚ùå La carpeta '/shared-logs' no existe."
            fi
          '''
        }
      }
    }

  }

  post {
    always {
      script {
        cleanWs()
      }
    }

    success {
      script {
        echo """
        ‚úÖ JAVA SPRING BOOT DEPLOYMENT EXITOSO ‚úÖ

        ======================= RESUMEN =======================
        üéØ Aplicaci√≥n:      ${GITHUB_REPO_URL_PRODUCER}
        üåø Rama:            ${GITHUB_BRANCH_PRODUCER}
        üè∑Ô∏è Entorno:         ${APP_ENVIRONMENT}
        ‚òï Java:            ${JAVA_VERSION}
        üì° Puerto:          8085
        ‚è±Ô∏è Tiempo:          ${currentBuild.durationString}
        ======================================================
        """
      }
    }

    failure {
      script {
        echo """
        ‚ùå FALLA EN DEPLOYMENT JAVA SPRING BOOT ‚ùå

        ====================== DIAGN√ìSTICO ===================
        Build:     #${BUILD_NUMBER}
        Error:     ${currentBuild.result}
        ======================================================
        """
        sh 'docker compose logs --tail=100 java-app || true'
        sh 'docker compose ps -a || true'
      }
    }
  }
}